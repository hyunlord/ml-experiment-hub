#!/usr/bin/env bash
# =============================================================================
# ML Experiment Hub — DGX Spark Setup
# =============================================================================
# One-time setup for NVIDIA DGX Spark (GB10 Grace-Blackwell).
#
# What it does:
#   1. Verifies prerequisites (Docker, NVIDIA Container Toolkit, disk space)
#   2. Creates data directories
#   3. Writes .env with DGX-specific paths
#   4. Builds Docker images
#   5. Initialises database
#   6. Runs a quick health-check
#
# Usage:
#   chmod +x scripts/setup_dgx.sh
#   ./scripts/setup_dgx.sh [--data-dir /path/to/data] [--checkpoint-dir /path/to/ckpt]
# =============================================================================
set -euo pipefail

# ── Defaults ────────────────────────────────────────────────────────────────
ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
DATA_DIR="${DATA_DIR:-$HOME/data}"
CHECKPOINT_DIR="${CHECKPOINT_DIR:-$HOME/checkpoints}"
PROJECTS_DIR="${PROJECTS_DIR:-$HOME/projects}"

# ── Parse args ──────────────────────────────────────────────────────────────
while [[ $# -gt 0 ]]; do
    case $1 in
        --data-dir)      DATA_DIR="$2";       shift 2 ;;
        --checkpoint-dir) CHECKPOINT_DIR="$2"; shift 2 ;;
        --projects-dir)  PROJECTS_DIR="$2";    shift 2 ;;
        *)               echo "Unknown arg: $1"; exit 1 ;;
    esac
done

# ── Colors ──────────────────────────────────────────────────────────────────
RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'; NC='\033[0m'
info()  { echo -e "${GREEN}[INFO]${NC}  $*"; }
warn()  { echo -e "${YELLOW}[WARN]${NC}  $*"; }
fail()  { echo -e "${RED}[FAIL]${NC}  $*"; exit 1; }

cd "$ROOT_DIR"
echo -e "${GREEN}"
echo "  ╔══════════════════════════════════════════════════╗"
echo "  ║   ML Experiment Hub — DGX Spark Setup            ║"
echo "  ╚══════════════════════════════════════════════════╝"
echo -e "${NC}"

# ── 1. Prerequisites ───────────────────────────────────────────────────────
info "[1/6] Checking prerequisites..."

command -v docker     &>/dev/null || fail "Docker not found. Install: https://docs.docker.com/engine/install/"
command -v nvidia-smi &>/dev/null || fail "nvidia-smi not found. Install NVIDIA drivers."

# Verify NVIDIA Container Toolkit
if docker run --rm --gpus all nvidia/cuda:12.4.0-base-ubuntu22.04 nvidia-smi &>/dev/null; then
    info "  NVIDIA Container Toolkit: OK"
else
    fail "NVIDIA Container Toolkit not working. Install: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/"
fi

# Disk space check (need at least 50 GB free)
FREE_GB=$(df -BG "$ROOT_DIR" | tail -1 | awk '{print $4}' | tr -d 'G')
if [ "$FREE_GB" -lt 50 ]; then
    warn "  Low disk space: ${FREE_GB}GB free (50GB+ recommended)"
else
    info "  Disk space: ${FREE_GB}GB free"
fi

# GPU info
info "  GPU detected:"
nvidia-smi --query-gpu=name,memory.total --format=csv,noheader | while IFS= read -r line; do
    info "    $line"
done

# ── 2. Directories ─────────────────────────────────────────────────────────
info "[2/6] Creating directories..."

mkdir -p "$DATA_DIR"
mkdir -p "$CHECKPOINT_DIR"
mkdir -p "$PROJECTS_DIR"
mkdir -p "$ROOT_DIR/data"  # DB + logs

info "  Data:        $DATA_DIR"
info "  Checkpoints: $CHECKPOINT_DIR"
info "  Projects:    $PROJECTS_DIR"

# ── 3. Environment file ────────────────────────────────────────────────────
info "[3/6] Writing .env..."

cat > "$ROOT_DIR/.env" <<EOF
# ML Experiment Hub — DGX Spark Environment
# Generated by setup_dgx.sh on $(date -Iseconds)

# Host paths mounted into containers (used by docker-compose.yml)
DATA_DIR=$DATA_DIR
CHECKPOINT_DIR=$CHECKPOINT_DIR
PROJECTS_DIR=$PROJECTS_DIR

# Backend configuration (used by backend/config.py Settings)
CHECKPOINT_BASE_DIR=/checkpoints
DATABASE_URL=sqlite+aiosqlite:////data/ml_hub.db
LOG_LEVEL=INFO
CORS_ORIGINS=["http://localhost:3000"]
EOF

info "  .env written (review with: cat .env)"

# ── 4. Docker build ────────────────────────────────────────────────────────
info "[4/6] Building Docker images..."
docker compose build --parallel
info "  Images built successfully"

# ── 5. Database init ───────────────────────────────────────────────────────
info "[5/6] Initialising database..."
docker compose up -d backend
sleep 5  # wait for DB init

# ── 6. Health check ─────────────────────────────────────────────────────────
info "[6/6] Running health check..."

RETRIES=10
while [ $RETRIES -gt 0 ]; do
    if curl -sf http://localhost:8002/api/system/health > /dev/null 2>&1; then
        info "  Backend healthy!"
        break
    fi
    RETRIES=$((RETRIES - 1))
    sleep 2
done

if [ $RETRIES -eq 0 ]; then
    warn "  Backend not responding yet — check: docker compose logs backend"
fi

# Show GPU info from the API
GPU_INFO=$(curl -sf http://localhost:8002/api/system/gpu-info 2>/dev/null || echo '{}')
if echo "$GPU_INFO" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f\"  GPU: {d['name']} ({d['vram_gb']} GB)\")" 2>/dev/null; then
    :
fi

# Stop backend (user will docker compose up when ready)
docker compose down

echo ""
echo -e "${GREEN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║  Setup complete!                                     ║${NC}"
echo -e "${GREEN}╚══════════════════════════════════════════════════════╝${NC}"
echo ""
echo "Next steps:"
echo "  1. Place COCO data in: $DATA_DIR/coco/"
echo "     (images in train2017/, val2017/; annotations in annotations/)"
echo ""
echo "  2. Place Korean caption JSONL in: $DATA_DIR/coco_ko/coco_ko.jsonl"
echo ""
echo "  3. Start the hub:"
echo "     docker compose up -d"
echo ""
echo "  4. Open the dashboard:"
echo "     http://localhost:3000"
echo ""
echo "  5. Create your first experiment:"
echo "     - Click 'New Experiment'"
echo "     - Select preset: DGX Spark (configs/dgx_spark.yaml)"
echo "     - Click 'Start Training'"
echo ""
echo "  API docs: http://localhost:8002/docs"
