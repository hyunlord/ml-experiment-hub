"""initial: create core tables

Revision ID: c2fe5ac0d414
Revises: 
Create Date: 2026-02-13 15:34:39.906551

"""
from typing import Sequence, Union

from alembic import op
import sqlmodel
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'c2fe5ac0d414'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('config_schemas',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sqlmodel.sql.sqltypes.AutoString(), nullable=False),
    sa.Column('description', sqlmodel.sql.sqltypes.AutoString(), nullable=False),
    sa.Column('fields_schema', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('config_schemas', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_config_schemas_name'), ['name'], unique=False)

    op.create_table('experiment_configs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sqlmodel.sql.sqltypes.AutoString(), nullable=False),
    sa.Column('description', sqlmodel.sql.sqltypes.AutoString(), nullable=False),
    sa.Column('config_json', sa.JSON(), nullable=True),
    sa.Column('config_schema_id', sa.Integer(), nullable=True),
    sa.Column('status', sa.Enum('DRAFT', 'QUEUED', 'RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED', name='experimentconfigstatus'), nullable=False),
    sa.Column('tags', sa.JSON(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.ForeignKeyConstraint(['config_schema_id'], ['config_schemas.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('experiment_configs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_experiment_configs_name'), ['name'], unique=False)

    op.create_table('experiment_runs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('experiment_config_id', sa.Integer(), nullable=False),
    sa.Column('status', sa.Enum('RUNNING', 'COMPLETED', 'FAILED', 'CANCELLED', name='runstatus'), nullable=False),
    sa.Column('pid', sa.Integer(), nullable=True),
    sa.Column('log_path', sqlmodel.sql.sqltypes.AutoString(), nullable=True),
    sa.Column('metrics_summary', sa.JSON(), nullable=True),
    sa.Column('checkpoint_path', sqlmodel.sql.sqltypes.AutoString(), nullable=True),
    sa.Column('started_at', sa.DateTime(), nullable=False),
    sa.Column('ended_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['experiment_config_id'], ['experiment_configs.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('experiment_runs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_experiment_runs_experiment_config_id'), ['experiment_config_id'], unique=False)

    op.create_table('metric_logs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('run_id', sa.Integer(), nullable=False),
    sa.Column('step', sa.Integer(), nullable=False),
    sa.Column('epoch', sa.Integer(), nullable=True),
    sa.Column('timestamp', sa.DateTime(), nullable=False),
    sa.Column('metrics_json', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['run_id'], ['experiment_runs.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('metric_logs', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_metric_logs_run_id'), ['run_id'], unique=False)

    op.create_table('system_stats',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('run_id', sa.Integer(), nullable=False),
    sa.Column('timestamp', sa.DateTime(), nullable=False),
    sa.Column('gpu_util', sa.Float(), nullable=True),
    sa.Column('gpu_memory_used', sa.Float(), nullable=True),
    sa.Column('gpu_memory_total', sa.Float(), nullable=True),
    sa.Column('cpu_percent', sa.Float(), nullable=True),
    sa.Column('ram_percent', sa.Float(), nullable=True),
    sa.ForeignKeyConstraint(['run_id'], ['experiment_runs.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    with op.batch_alter_table('system_stats', schema=None) as batch_op:
        batch_op.create_index(batch_op.f('ix_system_stats_run_id'), ['run_id'], unique=False)

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('system_stats', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_system_stats_run_id'))

    op.drop_table('system_stats')
    with op.batch_alter_table('metric_logs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_metric_logs_run_id'))

    op.drop_table('metric_logs')
    with op.batch_alter_table('experiment_runs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_experiment_runs_experiment_config_id'))

    op.drop_table('experiment_runs')
    with op.batch_alter_table('experiment_configs', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_experiment_configs_name'))

    op.drop_table('experiment_configs')
    with op.batch_alter_table('config_schemas', schema=None) as batch_op:
        batch_op.drop_index(batch_op.f('ix_config_schemas_name'))

    op.drop_table('config_schemas')
    # ### end Alembic commands ###
